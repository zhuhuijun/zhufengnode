<!DOCTYPE html>
<html data-ng-app="shopApp">
<head>
    <title></title>
    <meta charset="utf-8">
    <link href="lib/bootstrap/dist/css/bootstrap.css" rel="stylesheet">
    <style type="text/css">
        body {
            margin-top: 70px;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top" role="navigation" data-ng-controller="NavBarCtrl">
    <div class="navbar-header">
        <a class="navbar-brand" href="#/">珠峰商城</a>
    </div>
    <ul class="nav navbar-nav">
        <li><a data-ng-show="me" data-ng-class="{active:isActive('/home')}" href="#/home">首页</a></li>
        <li><a data-ng-hide="me" data-ng-class="{active:isActive('/users/reg')}" href="#/users/reg">注册</a></li>
        <li><a data-ng-hide="me" data-ng-class="{active:isActive('/users/login')}" href="#/users/login">登录</a></li>
    </ul>
    <ul class="nav navbar-nav navbar-right" data-ng-show="me">
        <li class="dropdown">
            <a href="#" data-ng-click="logout()">退出</a>
        </li>
    </ul>
</nav>
<div data-ng-view class="role"></div>
</body>
<script type="text/javascript" src="lib/jquery/dist/jquery.min.js"></script>
<script type="text/javascript" src="lib/bootstrap/dist/js/bootstrap.js"></script>
<script type="text/javascript" src="lib/angular/angular.js"></script>
<script type="text/javascript" src="lib/angular-route/angular-route.js"></script>
<script type="text/javascript">
    var app = angular.module('shopApp', ['ngRoute']);
    app.config(function ($routeProvider, $locationProvider) {

        $routeProvider
                .when('/', {
                    templateUrl: 'pages/home.html',
                    controller: 'HomeCtrl'
                })
                .when('/home', {
                    templateUrl: 'pages/home.html',
                    controller: 'HomeCtrl'
                })
                .when('/users/reg', {
                    templateUrl: 'pages/user/reg.html',
                    controller: 'RegCtrl'
                })
                .when('/users/login', {
                    templateUrl: 'pages/user/login.html',
                    controller: 'LoginCtrl'
                })
                .otherwise({
                    redirectTo: '/'
                });
    });
    //所有模块加载完的第一个方法
    app.run(function ($http, $rootScope, $location) {
        $http({
            url: '/users/validate',
            method: 'POST'
        }).success(function (usertt) {
                    $rootScope.me = usertt;//根上的用户
                    $location.path('/home');
                }).error(function (data) {
                    $location.path('/users/login');
                });
    });
    app.controller('HomeCtrl', function ($scope) {
        $scope.title = "珠峰商城";
    });
    app.controller('NavBarCtrl', function ($scope, $http, $location, $rootScope) {
        $scope.logout = function () {
            $http({
                url: '/users/logout',
                method: 'POST'
            }).success(function (msg) {
                        $rootScope.me = null;
                        $location.path('/users/login');
                    }).error(function (data) {
                        $location.path('/users/login');
                    });
        };
        $scope.isActive = function (path) {
            return path == $location.path();
        };
    });
    /*注册控制器**/
    app.controller('RegCtrl', function ($scope, $http, $location) {
        $scope.title = "注册";
        $scope.save = function () {
            $http({
                url: '/users/reg',
                method: 'POST',
                data: $scope.user
            }).success(function (userff) {
                        console.log(userff);
                        $location.path('/users/login');

                    }).error(function (data) {
                        console.log(data);
                        $location.path('/users/reg');
                    });
        };
    });
    /*登录控制器**/
    app.controller('LoginCtrl', function ($rootScope, $scope, $http, $location) {
        $scope.save = function () {
            $http({
                url: '/users/login',
                method: 'POST',
                data: $scope.user
            }).success(function (usertt) {
                        $rootScope.me = usertt;//根上的用户
                        $location.path('/home');
                    }).error(function (data) {
                        $location.path('/users/login');
                    });
            return false;
        };
    });

</script>
</html>